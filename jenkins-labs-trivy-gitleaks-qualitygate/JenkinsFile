pipeline {
  agent any

  options {
    timestamps()
  }

  environment {
    // Dla czytelności, wersje narzędzi trzymamy jawnie
    GITLEAKS_IMAGE = "zricethezav/gitleaks:v8.18.4"
    TRIVY_IMAGE    = "aquasec/trivy:0.50.2"
  }

  stages {
    stage('Checkout') {
      steps {
        echo "Workspace: ${env.WORKSPACE}"
        checkout scm
      }
    }

    stage('Secret scan (gitleaks)') {
      steps {
        sh '''
          set -e
          docker run --rm -v "$PWD":/repo -w /repo ${GITLEAKS_IMAGE} \
            detect --source=/repo --redact --no-git
        '''
      }
    }

    stage('Tests (pytest in docker)') {
      steps {
        sh '''
          set -e
          docker run --rm -v "$PWD":/work -w /work python:3.12-slim \
            sh -lc "pip install -r requirements.txt && pytest -q --junitxml=pytest.xml"
        '''
      }
    }

    stage('Vuln scan (trivy filesystem)') {
      steps {
        sh '''
          set -e
          # Skan repo jako filesystem (SCA + OS packages jeśli są)
          # --exit-code 1: pipeline failuje przy wykryciu podatności o danym poziomie
          docker run --rm -v "$PWD":/work -w /work ${TRIVY_IMAGE} fs \
            --scanners vuln,secret,config \
            --severity HIGH,CRITICAL \
            --exit-code 1 \
            --no-progress \
            .
        '''
      }
    }

    stage('Artifacts') {
      steps {
        archiveArtifacts artifacts: 'pytest.xml', fingerprint: true
      }
    }
  }
}

